
&НаСервере
Процедура ЗагрзитьКурсыНаСервере()
	// Вставить содержимое обработчика.   
	
ДанныеОКурсах = ДанныеОКурсахССайта();

	
ЗагрзитьКурсыВРегистр(ДанныеОКурсах)	;


	
КонецПроцедуры

&НаКлиенте
Процедура ЗагрзитьКурсы(Команда)
	ЗагрзитьКурсыНаСервере();   
	
	ПоказатьОповещениеПользователя("Курсы загружены");	

КонецПроцедуры


&НаСервере
Функция ДанныеОКурсахССайта()

      Соединение= Новый HTTPСоединение("www.cbr-xml-daily.ru",,,,,,Новый ЗащищенноеСоединениеOpenSSL);
	  
      Запрос = Новый HTTPЗапрос("/daily_utf8.xml");
	  Ответ = Соединение.Получить(Запрос);
	  Если Ответ.КодСостояния <> 200 Тогда
		  
     ВызватьИсключение "Не удалось получить ответ от сайта";
			
			
	  КонецЕсли;
	  
	  
	  Возврат Ответ.ПолучитьТелоКакСтроку();
	  
	  
	  
КонецФункции



&НаСервере
Процедура ЗагрзитьКурсыВРегистр(Данные)
	// Вставить содержимое обработчика.   
	
     Чтение = Новый ЧтениеXML;
	 Чтение.УстановитьСтроку(Данные,,);
	 
	 ПостроительDOM = Новый ПостроительDOM;
	 Документ =    ПостроительDOM.Прочитать(Чтение);
	 
	 
	 Для каждого УзелВалюты из Документ.ЭлементДокумента.ДочерниеУзлы Цикл
		         КодВалюты = "";
				 КурсВалюты = 0;
				 Кратность  = 0;
		 
				 Для каждого СвойстваВалюты из УзелВалюты.ДочерниеУзлы Цикл   
					 
					 Если СвойстваВалюты.ИмяУзла = "CharCode" Тогда
					   КодВалюты = СвойстваВалюты.ТекстовоеСодержимое;	 
						 
					 КонецЕсли;
					 
					 Если СвойстваВалюты.ИмяУзла = "Nominal" Тогда
					    Кратность = СвойстваВалюты.ТекстовоеСодержимое;	 
						 
					 КонецЕсли;Если СвойстваВалюты.ИмяУзла = "Value" Тогда
					   КурсВалюты = СвойстваВалюты.ТекстовоеСодержимое;	 
						 
				   КонецЕсли;      
				   
				   ВалютаССылка = Справочники.Валюты.НайтиПоКоду(КодВалюты);
				   
				   Если ЗначениеЗаполнено(ВалютаССылка) Тогда 
					   
					   Запись = РегистрыСведений.КурсыВалют.СоздатьМенеджерЗаписи();
					   Запись.Период = ТекущаяДата();
					   Запись.Валюта=ВалютаССылка;
					   Запись.Кратность = Число(Кратность);
					   Запись.Курс = Число(КурсВалюты);                
					   Запись.Записать(Истина);
				   КонецЕсли;	 
		         КонецЦикла;
	  КонецЦикла;
	 Чтение.Закрыть();

	
	
	
	
КонецПроцедуры
